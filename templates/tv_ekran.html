<!DOCTYPE html>
<html lang="sr">
  <head>
    <meta charset="UTF-8" />
    <title>Berza Koktela - LIVE</title>

    <style>
      body {
        background: #111;
        color: white;
        font-family: Arial, sans-serif;
        padding: 10px 20px;
        margin: 0;
      }

      .title-row {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 25px;
        margin-top: 10px;
        margin-bottom: 20px;
      }

      .logo {
        height: 60px;
        width: auto;
        opacity: 0.9;
      }

      h1 {
        text-align: center;
        font-size: 2.4em;
        margin: 0;
        color: #4caf50;
        white-space: nowrap;
      }

      #lista {
        display: flex;
        flex-wrap: wrap;
        justify-content: space-between;
      }

      .koktel-red {
        display: flex;
        align-items: center;
        justify-content: space-between;

        background: #1c1c1c;
        padding: 12px 14px;
        margin: 8px 0;
        border-radius: 10px;

        width: 48%;
        height: 80px;
        box-sizing: border-box;
      }

      .ime {
        width: 55%;
        font-size: 1.65em;
        font-weight: bold;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      /* PRICE + ARROW ARE NOW FULLY CENTERED */
      .cena {
        width: 40%;
        display: flex;
        justify-content: flex-end;
        align-items: center; /* ★ Align arrow vertically with price */
        gap: 8px;

        font-size: 2.6em;
        font-weight: bold;
      }

      .indikator {
        font-size: 1.4em;
        line-height: 1; /* ★ Prevent downward shift */
        position: relative;
        top: -2px; /* ★ Fine-tuned alignment */
      }

      .gore {
        color: #4caf50;
      }
      .dole {
        color: #ff4d4d;
      }
      .stabilno {
        color: #ccc;
      }
    </style>
  </head>

  <body>
    <div class="title-row">
      <img src="/static/shootiranje.png" class="logo" />
      <h1>Berza Koktela – LIVE</h1>
      <img src="/static/shootiranje.png" class="logo" />
    </div>

    <div id="lista"></div>

    <video
      id="clipVideo"
      muted
      autoplay
      playsinline
      style="
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 9999;
        background: #000;
      "
    ></video>

    <div
      id="promoTicker"
      style="
        display: none;
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: linear-gradient(90deg, #ff6600, #ff3300);
        color: #fff;
        padding: 18px;
        font-size: 1.8em;
        text-align: center;
        z-index: 9998;
        font-weight: bold;
      "
    >
    </div>

    <script>
      let clipPlaying = false;

      async function checkClip() {
        if (clipPlaying) return;

        const res = await fetch("/api/check_clip").then((r) => r.json());
        if (res.play) {
          clipPlaying = true;
          const video = document.getElementById("clipVideo");
          video.src = "/static/" + res.clip;
          video.style.display = "block";
          video.play();

          video.onended = () => {
            video.style.display = "none";
            // Zapocinjemo promociju jednog koktela
            startPromoCountdown(res.name, res.clip, res.price, res.REPLAY_INTERVAL, res.PROMO_SECONDS);
          };
        }
      }

      setInterval(checkClip, 2000);

      function startPromoCountdown(cocktailName, videoFile, promoPrice, interval, promoDuration) {
        let remaining = promoDuration;
        const ticker = document.getElementById("promoTicker");
        const video = document.getElementById("clipVideo");

        // Update ticker text dynamically for the current cocktail
        ticker.innerHTML = `${cocktailName} po promo ceni od ${promoPrice}din još <span id="countdown">${remaining}</span>`;
        ticker.style.display = "block";

        // Periodically show the video again during the 5-minute promo
        const replayInterval = setInterval(() => {
          if (remaining > 0) {
            video.src = "/static/" + videoFile;
            video.style.display = "block";
            video.currentTime = 0;
            video.play();
            video.onended = () => {
              video.style.display = "none";
            };
          }
        }, interval * 1000);

        // Main countdown timer
        const countdownInterval = setInterval(async () => {
          remaining--;
          const mins = Math.floor(remaining / 60);
          const secs = remaining % 60;

          const countdownEl = document.getElementById("countdown");
          if (countdownEl) {
            countdownEl.textContent = `${mins}:${secs.toString().padStart(2, "0")}`;
          }

          if (remaining <= 0) {
            clearInterval(countdownInterval);
            clearInterval(replayInterval);
            ticker.style.display = "none";
            video.style.display = "none";
            clipPlaying = false;

            // Move to next cocktail and trigger 15-minute wait on server
            await fetch("/api/next_cocktail");
          }
        }, 1000);
      }

      // Your existing ucitajSve() function remains here...
      async function ucitajSve() {
        const lista = document.getElementById("lista");
        lista.innerHTML = "";
        const kokteli = await fetch("/api/cene_uzivo").then((r) => r.json());
        for (const k of kokteli) {
          const red = document.createElement("div");
          red.className = "koktel-red";
          const arrow = k.smer === 1 ? "↗" : k.smer === -1 ? "↘" : "—";
          red.innerHTML = `
            <div class="ime">${k.naziv}</div>
            <div class="cena">
                ${k.cena.toFixed(2)}
                <span class="indikator ${k.smer === 1 ? "gore" : k.smer === -1 ? "dole" : "stabilno"}">
                    ${arrow}
                </span>
            </div>`;
          lista.appendChild(red);
        }
      }
      ucitajSve();
      setInterval(ucitajSve, 8000);
    </script>
  </body>
</html>