<!DOCTYPE html>
<html lang="sr">
<head>
    <meta charset="UTF-8">
    <title>Berza Koktela - LIVE</title>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body {
            background: #111;
            color: white;
            font-family: Arial, sans-serif;
            padding: 10px 20px;
            margin: 0;
        }

        h1 {
            text-align: center;
            font-size: 2.4em;
            margin: 10px 0 20px 0;
            color: #4CAF50;
        }

        /* Kompaktan red */
        .koktel-red {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #1c1c1c;
            padding: 8px 12px;
            margin: 8px auto;
            border-radius: 10px;
            width: 98%;
            height: 80px;   /* KLJUČNO za fitovanje */
        }

        .ime {
            width: 22%;
            font-size: 1.6em; /* manji font */
            font-weight: bold;
            white-space: nowrap;
        }

        .cena {
            width: 15%;
            text-align: center;
            font-size: 1.6em;
            font-weight: bold;
        }

        .indikator {
            font-size: 1.2em;
            margin-left: 6px;
        }

        .gore { color: #4CAF50; }
        .dole { color: #ff4d4d; }
        .stabilno { color: #ccc; }

        /* Mini sparkline grafikon */
        canvas {
            width: 58%;
            height: 65px;   /* prilagođeno da stane 10 redova */
        }
    </style>
</head>

<body>

<h1>Berza Koktela – LIVE</h1>

<div id="lista"></div>

<script>
async function ucitajSve() {

    const lista = document.getElementById("lista");
    lista.innerHTML = "";

    const kokteli = await fetch("/api/cene_uzivo").then(r => r.json());
    const bazne = await fetch("/api/cene_sa_baznom").then(r => r.json());

    for (const k of kokteli) {

        const red = document.createElement("div");
        red.className = "koktel-red";

        const bazna = bazne.find(x => x.id === k.id).bazna;

        red.innerHTML = `
            <div class="ime">${k.naziv}</div>

            <div class="cena">
                ${k.cena.toFixed(2)}
                <span class="indikator ${
                    k.smer === 1 ? "gore" :
                    k.smer === -1 ? "dole" : "stabilno"
                }">
                    ${k.smer === 1 ? "▲" : k.smer === -1 ? "▼" : "—"}
                </span>
            </div>

            <canvas id="chart_${k.id}"></canvas>
        `;

        lista.appendChild(red);

        iscrtajGrafikon(k.id, bazna);
    }
}


async function iscrtajGrafikon(id, bazna) {

    const istorija = await fetch(`/api/istorija_cena/${id}`).then(r => r.json());
    if (istorija.length === 0) return;

    const labels = istorija.map(x => x.vreme);
    const vrednosti = istorija.map(x => x.nova);
    const poslednja = vrednosti.at(-1);

    const linija = poslednja >= bazna ? "#4CAF50" : "#ff4d4d";
    const pozadina = poslednja >= bazna
        ? "rgba(76,175,80,0.25)"
        : "rgba(255,77,77,0.25)";

    new Chart(document.getElementById(`chart_${id}`).getContext("2d"), {
        type: "line",
        data: {
            labels,
            datasets: [{
                data: vrednosti,
                borderColor: linija,
                backgroundColor: pozadina,
                borderWidth: 2,
                fill: true,
                tension: 0.3
            }]
        },
        options: {
            plugins: { legend: { display: false }},
            scales: {
                x: { display: false },
                y: { display: false }
            },
            elements: {
                point: { radius: 0 }  // bez tačkica = sparkline stil
            }
        }
    });
}


ucitajSve();
setInterval(ucitajSve, 8000);
</script>

</body>
</html>
